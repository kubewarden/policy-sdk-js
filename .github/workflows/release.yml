name: Release
on:
  push:
    tags:
      - "v*"

permissions:
  id-token: write # Required for OIDC
  contents: read

jobs:
  ci:
    # A branch is required, and cannot be dynamic - https://github.com/actions/runner/issues/1493
    uses: ./.github/workflows/ci.yml
  e2e:
    uses: ./.github/workflows/e2e-tests.yml

  release:
    name: Create release
    runs-on: ubuntu-latest
    needs: [ci, e2e, publish]
    permissions:
      contents: write
    steps:
      - name: Retrieve tag name
        if: ${{ startsWith(github.ref, 'refs/tags/') }}
        run: |
          echo TAG_NAME=$(echo ${{ github.ref_name }}) >> $GITHUB_ENV
      - name: Get release ID from the release created by release drafter
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            let releases = await github.rest.repos.listReleases({
               owner: context.repo.owner,
               repo: context.repo.repo,
            });
            for (const release of releases.data) {
              if (release.draft) {
                      core.info(release)
                      core.exportVariable('RELEASE_ID', release.id)
                      return
              }
            }
            core.setFailed(`Draft release not found`)
      - name: Publish release
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const {RELEASE_ID} = process.env
            const {TAG_NAME} = process.env
            isPreRelease = ${{ contains(github.ref_name, '-alpha') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-rc') }}
            github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: `${RELEASE_ID}`,
              draft: false,
              tag_name: `${TAG_NAME}`,
              name: `${TAG_NAME}`,
              prerelease: isPreRelease,
              make_latest: !isPreRelease
            });

  publish:
    name: Publish on npm
    runs-on: ubuntu-latest
    needs: [ci, e2e]
    permissions:
      contents: read
      id-token: write # Required for npm provenance
    steps:
      - uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0

      - name: Install dependencies
        uses: kubewarden/github-actions/policy-gh-action-dependencies@247608f0b5a1562a6fd2576e5b2e6cbe62551baf # v4.5.15

      - name: Install javy
        shell: bash
        run: |
          #!/bin/bash
          set -e
          INSTALL_DIR=$HOME/.javy
          VERSION="v7.0.1"
          mkdir -p $INSTALL_DIR
          curl -sL https://github.com/bytecodealliance/javy/releases/download/${VERSION}/javy-x86_64-linux-${VERSION}.gz -o $INSTALL_DIR/javy.gz
          gzip -d -c $INSTALL_DIR/javy.gz > $INSTALL_DIR/javy
          rm $INSTALL_DIR/javy.gz
          chmod 755 $INSTALL_DIR/javy
          echo $INSTALL_DIR >> $GITHUB_PATH
          $INSTALL_DIR/javy -V

      - name: Build Javy plugin
        run: make build-plugin

      # Setup .npmrc file to publish to npm
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903 # v6.0.0
        with:
          node-version: "24.x"
          registry-url: "https://registry.npmjs.org"

      - name: Install npm dependencies in js directory
        run: |
          cd js
          npm ci

      - name: Verify git tag matches package.json version
        shell: bash
        run: |
          TAG="${GITHUB_REF#refs/tags/}"
          PKG_VERSION=$(jq -r '.version' js/package.json)
          if [ "$TAG" != "v$PKG_VERSION" ]; then
            echo "Version mismatch!"
            echo "Tag: $TAG"
            echo "package.json: v$PKG_VERSION"
            exit 1
          fi
          echo "Tag matches package.json version."

      - name: Build package
        run: |
          cd js
          npm run build

      - name: Publish to npm
        run: |
          cd js
          npm publish --provenance --access public
